From 39472c13cdbf8c7e81c007ea7e18f762c0b9a08e Mon Sep 17 00:00:00 2001
From: Seal <info@sealsecurity.io>
Date: Wed, 11 Jun 2025 17:03:36 +0300
Subject: [PATCH] v.0.1.37-sp1

---
 .github/workflows/lint.yaml              | 20 -------
 .github/workflows/reuse.yml              | 22 --------
 .github/workflows/test-i386.reusable.yml | 48 ++++++++++++++++
 .github/workflows/test-wasm.reusable.yml | 70 ++++++++++++++++++++++++
 .github/workflows/test.reusable.yml      | 58 ++++++++++++++++++++
 .github/workflows/test.yaml              | 45 ---------------
 6 files changed, 176 insertions(+), 87 deletions(-)
 delete mode 100644 .github/workflows/lint.yaml
 delete mode 100644 .github/workflows/reuse.yml
 create mode 100644 .github/workflows/test-i386.reusable.yml
 create mode 100644 .github/workflows/test-wasm.reusable.yml
 create mode 100644 .github/workflows/test.reusable.yml
 delete mode 100644 .github/workflows/test.yaml

diff --git a/.github/workflows/lint.yaml b/.github/workflows/lint.yaml
deleted file mode 100644
index 5dd3a99..0000000
--- a/.github/workflows/lint.yaml
+++ /dev/null
@@ -1,20 +0,0 @@
-#
-# DO NOT EDIT THIS FILE
-#
-# It is automatically copied from https://github.com/pion/.goassets repository.
-# If this repository should have package specific CI config,
-# remove the repository name from .goassets/.github/workflows/assets-sync.yml.
-#
-# If you want to update the shared CI config, send a PR to
-# https://github.com/pion/.goassets instead of this repository.
-#
-# SPDX-FileCopyrightText: 2023 The Pion community <https://pion.ly>
-# SPDX-License-Identifier: MIT
-
-name: Lint
-on:
-  pull_request:
-
-jobs:
-  lint:
-    uses: pion/.goassets/.github/workflows/lint.reusable.yml@master
diff --git a/.github/workflows/reuse.yml b/.github/workflows/reuse.yml
deleted file mode 100644
index 8633a12..0000000
--- a/.github/workflows/reuse.yml
+++ /dev/null
@@ -1,22 +0,0 @@
-#
-# DO NOT EDIT THIS FILE
-#
-# It is automatically copied from https://github.com/pion/.goassets repository.
-# If this repository should have package specific CI config,
-# remove the repository name from .goassets/.github/workflows/assets-sync.yml.
-#
-# If you want to update the shared CI config, send a PR to
-# https://github.com/pion/.goassets instead of this repository.
-#
-# SPDX-FileCopyrightText: 2023 The Pion community <https://pion.ly>
-# SPDX-License-Identifier: MIT
-
-name: REUSE Compliance Check
-
-on:
-  push:
-  pull_request:
-
-jobs:
-  lint:
-    uses: pion/.goassets/.github/workflows/reuse.reusable.yml@master
diff --git a/.github/workflows/test-i386.reusable.yml b/.github/workflows/test-i386.reusable.yml
new file mode 100644
index 0000000..3c45fe5
--- /dev/null
+++ b/.github/workflows/test-i386.reusable.yml
@@ -0,0 +1,48 @@
+# SPDX-FileCopyrightText: 2023 The Pion community <https://pion.ly>
+# SPDX-License-Identifier: MIT
+
+name: Test i386 (reusable)
+on:
+  push:
+  workflow_call:
+    inputs:
+      go-version:
+        required: true
+        type: string
+
+permissions:
+  contents: read
+
+jobs:
+  test-i386:
+    runs-on: ubuntu-latest
+    strategy:
+      matrix:
+        go-version: ['1.22', '1.23']
+    name: Go i386 ${{ matrix.go-version }}
+    steps:
+      - uses: actions/checkout@v4
+
+      - name: Build worker
+        run: |
+          docker build -t test_runner_i386_${{matrix.go-version}}:latest -<<EOF
+          FROM i386/golang:${{matrix.go-version}}-alpine
+          RUN go install github.com/gotesttools/gotestfmt/v2/cmd/gotestfmt@latest
+          EOF
+
+      - name: Run test
+        run: |
+          if [ -f .github/.ci.conf ]; then . .github/.ci.conf; fi
+          if [ -n "${SKIP_i386_TESTS}" ]; then exit 0; fi
+
+          mkdir -p $HOME/go/pkg/mod $HOME/.cache
+          docker run \
+            -u $(id -u):$(id -g) \
+            -e "GO111MODULE=on" \
+            -e "CGO_ENABLED=0" \
+            -v $GITHUB_WORKSPACE:/go/src/github.com/pion/$(basename $GITHUB_WORKSPACE) \
+            -v $HOME/go/pkg/mod:/go/pkg/mod \
+            -v $HOME/.cache:/.cache \
+            -w /go/src/github.com/pion/$(basename $GITHUB_WORKSPACE) \
+            test_runner_i386_${{matrix.go-version}}:latest \
+            /bin/sh -c "/usr/local/go/bin/go test ${TEST_EXTRA_ARGS:-} -json -v ./... | gotestfmt"              ${TEST_EXTRA_ARGS:-} \
diff --git a/.github/workflows/test-wasm.reusable.yml b/.github/workflows/test-wasm.reusable.yml
new file mode 100644
index 0000000..86e6ff1
--- /dev/null
+++ b/.github/workflows/test-wasm.reusable.yml
@@ -0,0 +1,70 @@
+# SPDX-FileCopyrightText: 2023 The Pion community <https://pion.ly>
+# SPDX-License-Identifier: MIT
+
+name: Test WASM (reusable)
+on:
+  push:
+  workflow_call:
+    inputs:
+      go-version:
+        required: true
+        type: string
+
+permissions:
+  contents: read
+
+jobs:
+  test-wasm:
+    runs-on: ubuntu-24.04
+    name: WASM
+    strategy:
+      matrix:
+        go-version: ['1.22', '1.23']
+    steps:
+      - uses: actions/checkout@v4
+
+      - name: Download Go
+        run: |
+          version=$(
+            curl -s 'https://go.dev/dl/?mode=json&include=all' \
+              | jq -r '.[].version | select(startswith("go${{ matrix.go-version }}."))' \
+              | sort -V \
+              | tail -n 1
+          )
+          curl -sSfL https://dl.google.com/go/${version}.linux-amd64.tar.gz | tar -C ~ -xzf -
+
+      - name: Node version
+        id: node-version
+        run: |
+          if [ '${{ matrix.go-version }}' = '1.20' ]; then
+            # Go 1.20's wasm_exec_node.js doesn't work with Node v20
+            # This can be removed once all pion repositories are switched to use Go 1.22
+            echo 'version=16' | tee -a ${GITHUB_OUTPUT}
+          fi
+
+      - name: Use Node.js
+        uses: actions/setup-node@v4
+        with:
+          node-version: '${{ steps.node-version.outputs.version || 20 }}.x'
+
+      - name: Set Go Root
+        run: echo "GOROOT=${HOME}/go" >> $GITHUB_ENV
+
+      - name: Set Go Path
+        run: echo "GOPATH=${HOME}/go" >> $GITHUB_ENV
+
+      - name: Set Go Path
+        run: echo "GO_JS_WASM_EXEC=${GOROOT}/misc/wasm/go_js_wasm_exec" >> $GITHUB_ENV
+
+      - name: Install NPM modules
+        run: yarn install
+
+      - name: Run Tests
+        run: |
+          if [ -f .github/.ci.conf ]; then . .github/.ci.conf; fi
+          GOOS=js GOARCH=wasm \
+          ${GOPATH}/bin/go test \
+            -coverprofile=cover.out \
+            -covermode=atomic \
+            -exec="${GO_JS_WASM_EXEC}" \
+            -v ./...
diff --git a/.github/workflows/test.reusable.yml b/.github/workflows/test.reusable.yml
new file mode 100644
index 0000000..616a985
--- /dev/null
+++ b/.github/workflows/test.reusable.yml
@@ -0,0 +1,58 @@
+# SPDX-FileCopyrightText: 2023 The Pion community <https://pion.ly>
+# SPDX-License-Identifier: MIT
+
+name: Test
+on:
+  push:
+  workflow_call:
+    inputs:
+      go-version:
+        required: true
+        type: string
+
+permissions:
+  contents: read
+
+jobs:
+  test:
+    runs-on: ubuntu-24.04
+    strategy:
+      matrix:
+        go-version: ['1.22', '1.23']
+    name: Go ${{ matrix.go-version }}
+    steps:
+      - uses: actions/checkout@v4
+        with:
+          fetch-depth: 0
+
+      - name: Setup Go
+        uses: actions/setup-go@v5
+        with:
+          go-version: ${{ matrix.go-version }}
+
+      - name: Setup go-acc
+        run: go install github.com/ory/go-acc@latest
+
+      - name: Setup gotestfmt
+        uses: haveyoudebuggedit/gotestfmt-action@v2
+
+      - name: Run pre test hook
+        run: |
+          if [ -f .github/.ci.conf ]; then . .github/.ci.conf; fi
+          if [ -n "${PRE_TEST_HOOK}" ]; then ${PRE_TEST_HOOK}; fi
+
+      - name: Run test
+        run: |
+          TEST_BENCH_OPTION="-bench=."
+          if [ -f .github/.ci.conf ]; then . .github/.ci.conf; fi
+
+          set -euo pipefail
+          go-acc -o cover.out ./... -- \
+            ${TEST_BENCH_OPTION} \
+            -json \
+            -v -race 2>&1 | grep -v '^go: downloading' | tee /tmp/gotest.log | gotestfmt
+
+      - name: Run post test hook
+        run: |
+          if [ -f .github/.ci.conf ]; then . .github/.ci.conf; fi
+          if [ -n "${POST_TEST_HOOK}" ]; then ${POST_TEST_HOOK}; fi
diff --git a/.github/workflows/test.yaml b/.github/workflows/test.yaml
deleted file mode 100644
index b024289..0000000
--- a/.github/workflows/test.yaml
+++ /dev/null
@@ -1,45 +0,0 @@
-#
-# DO NOT EDIT THIS FILE
-#
-# It is automatically copied from https://github.com/pion/.goassets repository.
-# If this repository should have package specific CI config,
-# remove the repository name from .goassets/.github/workflows/assets-sync.yml.
-#
-# If you want to update the shared CI config, send a PR to
-# https://github.com/pion/.goassets instead of this repository.
-#
-# SPDX-FileCopyrightText: 2023 The Pion community <https://pion.ly>
-# SPDX-License-Identifier: MIT
-
-name: Test
-on:
-  push:
-    branches:
-      - master
-  pull_request:
-
-jobs:
-  test:
-    uses: pion/.goassets/.github/workflows/test.reusable.yml@master
-    strategy:
-      matrix:
-        go: ["1.23", "1.22"] # auto-update/supported-go-version-list
-      fail-fast: false
-    with:
-      go-version: ${{ matrix.go }}
-    secrets: inherit
-
-  test-i386:
-    uses: pion/.goassets/.github/workflows/test-i386.reusable.yml@master
-    strategy:
-      matrix:
-        go: ["1.23", "1.22"] # auto-update/supported-go-version-list
-      fail-fast: false
-    with:
-      go-version: ${{ matrix.go }}
-
-  test-wasm:
-    uses: pion/.goassets/.github/workflows/test-wasm.reusable.yml@master
-    with:
-      go-version: "1.23" # auto-update/latest-go-version
-    secrets: inherit
-- 
2.39.5

